# 基础

## 项目是做什么的

这个项目是我所在的云顶书院社团，由我和小组成员一起完成的一个项目。

『待见』项目立项来源于我们指导老师高航老师提出的新型社交电商模式，主要是通过社交和电商平台结合，形成农户到消费者的点对点销售渠道，降低中间成本，让农户与消费者都能得利。

项目本身是基于SpirngBoot的SSM框架，数据库采用MySQL+Redis，消息中间件使用了RabbitMQ，整体分为社交平台、电商和支付三个系统。

然后我所负责的部分是电商的部分，主要业务模块就是购物车的管理、订单的创建和商品的管理。

## 为什么要做这个项目

『待见』项目立项来源于我们指导老师高航老师提出的新型社交电商模式，主要是通过社交和电商平台结合，形成农户到消费者的点对点销售渠道，降低中间成本，让农户与消费者都能得利。

于我个人而言，在社团里也是主学Java语言，刚好有这么一个机会，可以锻炼自己，于是就参与这个项目组。

## 项目是不是跟着视频做的

不是。项目立项的时候确实有参考过github的开源项目和b站上的一些教程，但实际开发的过程中是自己整合相关知识进行开发，算是学以致用

# 数据库

## 表设计

我负责的模块主要是商品、订单和购物车

- **商品：**用了两个表，一个是分类表，一个是商品表

  - **分类表：**

    分类表主要是**主键id**，和**分类名**，还有一个**排序的sort_order**来实现展示时的优先级。还有就是逻辑删除、增改时间这些

    然后分类旗下有子分类，所以通过表里的**父类id**来维护树状关系，这块因为分类的数据量不是很大，所以业务上实现的方式是一次性读取表里的所有数据，维护好层级关系后放入Redis

  - **商品表：**

    |    字段     |   说明   |
    | :---------: | :------: |
    |     id      |   主键   |
    | category_id |  分类id  |
    |    name     |  商品名  |
    |  subtitle   |  副标题  |
    |   detail    | 商品详情 |
    | main_image  | 封面地址 |
    |  sub_image  | 详情图片 |
    |    price    |   价格   |
    |    stock    |   库存   |

- **订单：**订单有两个表，一个是支付表，用于和支付系统对接，还有一个订单表，存储用户订单信息

  - **支付表：**

    |      字段       |          说明           |
    | :-------------: | :---------------------: |
    |       id        |          主键           |
    |    order_no     |         订单号          |
    |    platform     | 支付平台（微信/支付宝） |
    | platform_number |  支付平台提供的流水号   |
    | platform_status |   订单状态(是否支付)    |
    |   pay_amount    |        支付金额         |
    |                 |      交易完成时间       |
    |                 |      交易关闭事件       |
    |                 |                         |

  - **订单表：** 

    实现逻辑是**一种商品创建一个订单表**，**订单表和支付表是多对一关系**，支付表中的一次性支付金额就是订单表中每种商品总价的总和

    |        字段        |                        说明                         |
    | :----------------: | :-------------------------------------------------: |
    |         id         |                        主键                         |
    |      user_id       |                       用户id                        |
    |      order_no      |                       订单号                        |
    |     product_id     |                       商品id                        |
    |    product_name    | 商品名<br />(商品信息会波动，下订单时锁死商品信息） |
    |   product_image    |                      商品图标                       |
    | current_unit_price |  单价<br />（商品价格会波动，但下订单时锁定金额）   |
    |      quantity      |                        数量                         |
    |    total_price     |                     总价，同上                      |
    |     send_time      |                      发货时间                       |
    |      end_time      |  交易完成时间（记录订单状态，方便查询和排查问题）   |
    |     close_time     |                    交易关闭时间                     |

- **购物车：**购物车功能主要在Redis上实现

- **地址表：**

  - 用户id
  - 收货人姓名
  - 收货人电话
  - 省份、城市、区县
  - 详细地址

## 数据库索引

- **唯一索引：**

  订单号、商品编号这类已经确定了一定不会也不能重复的编号添加了UNIQUE KEY

- **普通索引：**

  - 订单表上为了方便查询，设置了订单号的索引和用户名与订单号组成的联合索引

## 排查慢SQL

以我做的项目为例吧

1. 首先可以看看故障时段，应该能推断出和哪个功能相关
2. 系统如果能在流量峰值后自动恢复，那应该不是因为后台服务被大量请求打死（内存溢出、栈溢出或者进程直接挂掉），可以把重点放在MySQL上 
3. 首先看看MySQL的CPU利用率曲线，如果一直很高基本就确定是SQL导致的，偶尔一条SQL执行的很慢，要考虑可能是**刷脏页**、**锁冲突**的情况
4. 去查慢查询日志，定位执行效率比较低的SQL，里面的explain关键字能提供很多信息，如索引有没有生效、扫描行数，有没有回表这些
   - **索引优化** 避免全表扫描、避免回表，尽量覆盖索引，索引区分度也要高避免系统自动优化不适用索引
   - **排序优化** 尽量使用索引排序，避免回表
   - **分页优化** 比如偏移量大的时候
   - **join优化** 小表驱动大表
   - **避免大事务** 把大事务的复杂SQL拆分成多个小SQL，将结果在程序中封装，这样可以尽量减小事务粒度，减少锁表的时间
5. 通过慢查询日志的分析，然后去修改烂SQL，就是优化索引，对分页、插入进行优化这些，也可以对一些查询比较慢的热点数据直接在Redis里做缓存 
6. 还慢的话就得考虑数据库问题了，可能是参数设置不当，单机性能受限这些。

**要优化的话：**

- **可以考虑上线一个定时监控和杀掉慢SQL的脚本**，比如一分钟检测一次，看看有没有执行时间超过某个阈值的慢SQL并杀掉它，防止拖垮整个数据库
- **给模块做降级**，就比如说我那个项目，首页进去就有很多商品信息，可以考虑让前端给它做降级，在nginx做一个策略就是请求数据超时就用一个静态首页作为替代这样，暂时降级，至少不会影响到用户其他功能

# 商品

## 商品管理如何实现

商品管理大致就三个功能：

- 查询目录（分类）
  - 根据分类查询，通过分类id查询
  - 查询所有分类，直接查出表中所有数据，然后再程序里递归构建层级关系（用stream流，把所有父类id相同的子类串成链表挂在父类下）
- 查询商品列表
  - 根据分类id查出商品，要注意就是由前端提供分页信息
- 查询商品详情
  - 根据商品id查询，需要判断商品是否下架或删除，然后对敏感数据比如库存，大于一定值就用固定数值替代了
  - 下订单和取消订单时会对应增减商品，同时判断商品库存来确保及时修改商品状态

## 商品信息假如字段越来越多，且流量上来了怎么办

