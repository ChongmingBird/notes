# 【支付功能】

## 微信支付

![image-20230330153617781](https://chongming-images.oss-cn-hangzhou.aliyuncs.com/images-masterimage-20230330153617781.png)

## 同步/异步

**支付中的同步和异步：**

指的是用户支付后，服务器获取支付结果的两种不同方法。

这两种方法是相互独立的，各有优劣，相辅相成。这两种方法可以单独使用，任意一种一般情况下都可以回调成功，为了安全和用户体验，两种回调方法并存。

- 同步：发送方发出数据后，等接收方发回响应以后才发下一个数据包的通讯方式。
- 异步：发送方发出数据后，不等接收方发回响应，接着发送下个数据包的通讯方式。  

**区别：**

- 同步回调只有一次，异步回调可以有多次
  - 同步回调只有一次，那这一次的结果就是最终结果，回调成功就是成功，回调失败就是失败；
  - 异步回调如果失败，在失效时间内会继续回调，直到成功为止。
  - 异步回调第一次收到订单信息是与返回页近乎等同的时间，在判断不成功的情况下，会收到第二次第三次的通知，时间间隔从最先的一两分钟，到后面的几个小时。失效时间是48小时
- 同步回调使用get请求传参；异步回调使用post请求传参
- 同步是客户端回调；异步是服务器端回调

> 当一个支付请求被发送到支付渠道方，支付渠道会很快返回一个结果。但是这个结果，只是告诉你调用成功了，不是扣款成功，这叫同步调用。
> 很多新手会拿这个结果 当作支付成功了，那就会被坑死，结果就是支付成功率特别高，伴随着一堆无法解释的坏账率，测试人员尤其要注意测试数据的篡改：金额，同步返回结果，订单号等。
>
> 同步请求参数里面会有一个回调地址，这个地址是支付渠道在扣款成功后调用的，这叫异步调用。
> 一般同步接口仅检查参数是否正确，签名是否无误等。异步接口才告诉你扣款结果。
> 一般异步接口有5秒以内的延迟。调用不成功会重试。有时候是这边成功了，但支付渠道侧没收到返回，于是会继续调。
> 当天的支付到第二天还在 被异步调用也都是正常的。这也是开发人员需要特别注意的地方，不要当做重复支付。
> 测试人员也要对重复回调进行测试，应只有一次有效。这还不是最坑的，一般 支付渠道侧，只有支付成功了才通知你。
> 要是支付失败了，压根儿都不告诉你。
> 另一方面，如何老收不到异步结果呢？那就得查查了。同步结果不可靠，异步调用不可靠，那怎么确定支付结果？最终的杀招就是查单了，
> 反查，一般支付渠道侧都 会提供反查接口，定时获取DB中待支付的订单调用支付渠道侧的反查接口，最终把支付渠道侧扣款成功的订单完成掉
